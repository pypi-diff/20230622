# Comparing `tmp/siat-2.1.5-py3-none-any.whl.zip` & `tmp/siat-2.1.6-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,8 +1,8 @@
-Zip file size: 1693057 bytes, number of entries: 120
+Zip file size: 1694808 bytes, number of entries: 120
 -rw-rw-rw-  2.0 fat      840 b- defN 23-Apr-10 11:29 siat/__init__.py
 -rw-rw-rw-  2.0 fat     2130 b- defN 23-Apr-10 11:29 siat/allin.py
 -rw-rw-rw-  2.0 fat      747 b- defN 23-Apr-10 11:29 siat/alpha_vantage_test.py
 -rw-rw-rw-  2.0 fat    28555 b- defN 23-Apr-10 11:29 siat/assets_liquidity.py
 -rw-rw-rw-  2.0 fat     1285 b- defN 23-Apr-10 11:29 siat/assets_liquidity_test.py
 -rw-rw-rw-  2.0 fat    10110 b- defN 23-Apr-10 11:29 siat/barrons_scraping_test.py
 -rw-rw-rw-  2.0 fat    36597 b- defN 23-Apr-10 11:29 siat/beta_adjustment.py
@@ -51,15 +51,15 @@
 -rw-rw-rw-  2.0 fat  2047492 b- defN 23-Jun-05 00:28 siat/fund_china.pickle
 -rw-rw-rw-  2.0 fat    74734 b- defN 23-Jun-10 07:59 siat/fund_china.py
 -rw-rw-rw-  2.0 fat     6649 b- defN 23-Apr-10 11:29 siat/fund_china_test.py
 -rw-rw-rw-  2.0 fat     1116 b- defN 23-Apr-10 11:29 siat/fund_test.py
 -rw-rw-rw-  2.0 fat    17513 b- defN 23-Jun-10 08:35 siat/future_china.py
 -rw-rw-rw-  2.0 fat     1163 b- defN 23-Apr-10 11:29 siat/future_china_test.py
 -rw-rw-rw-  2.0 fat     2402 b- defN 23-Apr-10 11:29 siat/global_index_test.py
--rw-rw-rw-  2.0 fat    64367 b- defN 23-Jun-18 17:17 siat/grafix.py
+-rw-rw-rw-  2.0 fat    65659 b- defN 23-Jun-19 16:30 siat/grafix.py
 -rw-rw-rw-  2.0 fat     3150 b- defN 23-Apr-10 11:29 siat/grafix_test.py
 -rw-rw-rw-  2.0 fat    30544 b- defN 23-Apr-10 11:29 siat/holding_risk.py
 -rw-rw-rw-  2.0 fat      474 b- defN 23-Apr-10 11:29 siat/holding_risk_test.py
 -rw-rw-rw-  2.0 fat     3936 b- defN 23-Apr-10 11:29 siat/local_debug_test.py
 -rw-rw-rw-  2.0 fat    31158 b- defN 23-Apr-10 11:29 siat/market_china.py
 -rw-rw-rw-  2.0 fat    95641 b- defN 23-Apr-10 13:16 siat/markowitz.py
 -rw-rw-rw-  2.0 fat     1593 b- defN 23-Apr-10 11:29 siat/markowitz_ccb_test.py
@@ -81,19 +81,19 @@
 -rw-rw-rw-  2.0 fat    75061 b- defN 23-Apr-10 11:29 siat/risk_evaluation.py
 -rw-rw-rw-  2.0 fat     3731 b- defN 23-Apr-10 11:29 siat/risk_evaluation_test.py
 -rw-rw-rw-  2.0 fat    12304 b- defN 23-Apr-10 11:29 siat/risk_free_rate.py
 -rw-rw-rw-  2.0 fat     4285 b- defN 23-Apr-10 11:29 siat/risk_free_rate_test.py
 -rw-rw-rw-  2.0 fat   101523 b- defN 23-May-27 06:22 siat/sector_china.py
 -rw-rw-rw-  2.0 fat     5843 b- defN 23-Apr-11 14:17 siat/sector_china_test.py
 -rw-rw-rw-  2.0 fat    29185 b- defN 23-May-25 02:36 siat/security_price.py
--rw-rw-rw-  2.0 fat    72184 b- defN 23-Jun-07 15:20 siat/security_prices.py
+-rw-rw-rw-  2.0 fat    72866 b- defN 23-Jun-19 07:51 siat/security_prices.py
 -rw-rw-rw-  2.0 fat    10779 b- defN 23-Apr-10 11:29 siat/security_prices_test.py
 -rw-rw-rw-  2.0 fat     1335 b- defN 23-Apr-10 11:29 siat/setup.py
 -rw-rw-rw-  2.0 fat     1418 b- defN 23-Apr-10 11:29 siat/shenwan index history test.py
--rw-rw-rw-  2.0 fat   118820 b- defN 23-Jun-18 16:38 siat/stock.py
+-rw-rw-rw-  2.0 fat   123451 b- defN 23-Jun-19 16:53 siat/stock.py
 -rw-rw-rw-  2.0 fat    31655 b- defN 23-Apr-10 11:29 siat/stock_advice_linear.py
 -rw-rw-rw-  2.0 fat     1312 b- defN 23-Apr-10 11:29 siat/stock_base.py
 -rw-rw-rw-  2.0 fat    82785 b- defN 23-Jun-17 02:52 siat/stock_china.py
 -rw-rw-rw-  2.0 fat     1294 b- defN 23-Jun-14 07:32 siat/stock_china_test.py
 -rw-rw-rw-  2.0 fat  1266744 b- defN 23-Jun-05 00:13 siat/stock_info.pickle
 -rw-rw-rw-  2.0 fat     6122 b- defN 23-Apr-10 11:29 siat/stock_info_test.py
 -rw-rw-rw-  2.0 fat     1014 b- defN 23-Apr-10 11:29 siat/stock_list_china_test.py
@@ -111,12 +111,12 @@
 -rw-rw-rw-  2.0 fat   118133 b- defN 23-Apr-10 11:29 siat/translate-20230206.py
 -rw-rw-rw-  2.0 fat   121657 b- defN 23-Apr-10 11:29 siat/translate-20230215.py
 -rw-rw-rw-  2.0 fat   133928 b- defN 23-Jun-18 17:34 siat/translate.py
 -rw-rw-rw-  2.0 fat     3936 b- defN 23-Apr-10 11:29 siat/universal_test.py
 -rw-rw-rw-  2.0 fat    51342 b- defN 23-May-11 00:30 siat/valuation_china.py
 -rw-rw-rw-  2.0 fat     1571 b- defN 23-Apr-10 11:29 siat/valuation_market_china_test.py
 -rw-rw-rw-  2.0 fat    14859 b- defN 23-Apr-10 11:29 siat/var_model_validation.py
--rw-rw-rw-  2.0 fat     1410 b- defN 23-Jun-18 17:40 siat-2.1.5.dist-info/METADATA
--rw-rw-rw-  2.0 fat       92 b- defN 23-Jun-18 17:40 siat-2.1.5.dist-info/WHEEL
--rw-rw-rw-  2.0 fat        5 b- defN 23-Jun-18 17:40 siat-2.1.5.dist-info/top_level.txt
-?rw-rw-r--  2.0 fat     9602 b- defN 23-Jun-18 17:40 siat-2.1.5.dist-info/RECORD
-120 files, 7737243 bytes uncompressed, 1678417 bytes compressed:  78.3%
+-rw-rw-rw-  2.0 fat     1410 b- defN 23-Jun-22 13:44 siat-2.1.6.dist-info/METADATA
+-rw-rw-rw-  2.0 fat       92 b- defN 23-Jun-22 13:44 siat-2.1.6.dist-info/WHEEL
+-rw-rw-rw-  2.0 fat        5 b- defN 23-Jun-22 13:44 siat-2.1.6.dist-info/top_level.txt
+?rw-rw-r--  2.0 fat     9602 b- defN 23-Jun-22 13:44 siat-2.1.6.dist-info/RECORD
+120 files, 7743848 bytes uncompressed, 1680168 bytes compressed:  78.3%
```

## zipnote {}

```diff
@@ -342,20 +342,20 @@
 
 Filename: siat/valuation_market_china_test.py
 Comment: 
 
 Filename: siat/var_model_validation.py
 Comment: 
 
-Filename: siat-2.1.5.dist-info/METADATA
+Filename: siat-2.1.6.dist-info/METADATA
 Comment: 
 
-Filename: siat-2.1.5.dist-info/WHEEL
+Filename: siat-2.1.6.dist-info/WHEEL
 Comment: 
 
-Filename: siat-2.1.5.dist-info/top_level.txt
+Filename: siat-2.1.6.dist-info/top_level.txt
 Comment: 
 
-Filename: siat-2.1.5.dist-info/RECORD
+Filename: siat-2.1.6.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## siat/grafix.py

```diff
@@ -948,51 +948,97 @@
         print ("  #Warning(draw_lines): too many columns to draw lines, max 16 lines")
         return
     
     lslist=['-','--','-.',':','-','--','-.',':','-','--','-.',':','-','--','-.',':',]
     #mklist=[',','d','_','.','o','v','^','<','>','1','2','3','4','s','p','*','h','H','+','x','D']
     mklist=[',',',',',',',',',',',',',',',',',',',',',',',',',',',',',',',',',',',',',',',',',']
     
-    #绘制折线图    
+    # 所有字段转换为数值类型，以防万一
+    for c in collist:
+        df[c]=df[c].astype('float')
+    
+    """
+    # 计算所有列中的最大最小差距
+    dfmax=0; dfmin=0
+    for c in collist:
+        cmax=df[c].max()
+        if cmax > dfmax:
+            dfmax=cmax
+        
+        cmin=df[c].min()
+        if cmin < dfmin:
+            dfmin=cmin
+    dfspread=(dfmax - dfmin)/10.0
+    """
+    
+    # 将末端值最大的排在第一列，优先绘图
+    dftt=df.T
+    lastrow=list(dftt)[-1]
+    dftt.sort_values(lastrow,ascending=False,inplace=True)
+    df2=dftt.T
+    
+    # 最上层线标志
+    firstline=True
+    
+    #绘制折线图
+    y_end_list=[]    
     for c in collist:
         pos=collist.index(c)
         try:
             lsc=lslist[pos]
         except:
             print("  #Bug(draw_lines): lslist=",lslist,",pos=",pos)
         mkc=mklist[pos]
         
-        # 连接折现中非交易日的断开区间
+        # 连接折线中非交易日的断开区间
         import pandas as pd
-        dfg=pd.DataFrame(df[c]).copy(deep=True)
+        dfg=pd.DataFrame(df2[c]).copy(deep=True)
+        
         # 慎用dropna
         #dfg=dfg.dropna(inplace=True)
         if dfg is None:
             print("  #Error(draw_lines): null dataframe for graphics in column",c)
             continue
         if len(dfg)==0:
             print("  #Error(draw_lines): no data for graphics in column",c)
             continue
         
         #plt.plot(dfg,label=c,linewidth=linewidth,ls=lsc,marker=mkc,markersize=3)
         if not annotate:
             plt.plot(dfg,label=codetranslate(c),linewidth=linewidth,ls=lsc,marker=mkc,markersize=3)
         else:
-            plt.plot(dfg[c],label=codetranslate(c),linewidth=linewidth,ls=lsc,marker=mkc,markersize=3)
+            #plt.plot(dfg[c],label=codetranslate(c),linewidth=linewidth,ls=lsc,marker=mkc,markersize=3)
+            plt.plot(dfg,label=codetranslate(c),linewidth=linewidth,ls=lsc,marker=mkc,markersize=3)
+            
             df_end=dfg.tail(1)
-            y_end = round(df_end[c].min(),2)    # 末端的y坐标
+            # df_end[c]必须为数值类型，否则可能出错
+            y_end = df_end[c].min()    # 末端的y坐标
             x_end = df_end[c].idxmin() # 末端值的x坐标 
-            plt.annotate(text=codetranslate(c)+':'+str(y_end), 
+            
+            """
+            if firstline:
+                # 直接绘图
+                firstline=False
+                y_prev=y_end
+            else:
+                distance=y_prev - y_end
+                if distance < dfspread:
+                    y_end=y_end - dfspread
+                    y_prev=y_end
+            y_end_list=y_end_list+[y_end]
+            """
+            
+            plt.annotate(text=codetranslate(c)+':'+str(round(y_end,2)), 
                                  xy=(x_end, y_end),
                                  xytext=(x_end, y_end),fontsize=9)   
             
         #plt.plot(df[c],label=c,linewidth=1.5,marker=mkc,markersize=3)
         #为折线加数据标签
         if data_label==True:
-            for a,b in zip(df.index,df[c]):
+            for a,b in zip(df2.index,df2[c]):
                 plt.text(a,b+0.02,str(round(b,2)), \
                          ha='center',va='bottom',fontsize=7)
     
     #绘制水平辅助线
     if axhline_label !="":
         if '零线' in axhline_label:
             axhline_label=''
```

## siat/security_prices.py

```diff
@@ -1445,33 +1445,40 @@
     period="Weekly"
     prdf=calc_rolling_return(drdf, period) 
     prdf=calc_rolling_return(drdf, "Monthly")
     prdf=calc_rolling_return(drdf, "Quarterly")
     prdf=calc_rolling_return(drdf, "Annual")
 
 #==============================================================================
-def calc_expanding_return(drdf,basedate):
+def calc_expanding_return(drdf0,basedate):
     """
     功能：基于日收益率数据集，从起始日期开始到结束日期的扩展窗口收益率序列。
     输入：
     日收益率数据集drdf。
     输出：期间累计收益率序列，按照日期升序排列。
     """
+    import pandas as pd
+    basedate_pd=pd.to_datetime(basedate)
+    drdf=drdf0[drdf0.index >= basedate_pd]
     
     #计算累计收益率：基于收盘价
     retname1="Exp Ret"
     retname2="Exp Ret%"
     import numpy as np
-    drdf[retname1]=np.exp(drdf[drdf.index >= basedate]["log(Daily Ret)"].expanding(min_periods=1).sum())-1.0
+    #drdf[retname1]=np.exp(drdf["log(Daily Ret)"].expanding(min_periods=1).sum())-1.0
+    first_close=drdf.head(1)['Close'].values[0]
+    drdf[retname1]=drdf['Close']/first_close-1
     drdf[retname2]=drdf[retname1]*100.0  
     
     #计算累计收益率：基于调整收盘价
     retname3="Exp Adj Ret"
     retname4="Exp Adj Ret%"
-    drdf[retname3]=np.exp(drdf[drdf.index >= basedate]["log(Daily Adj Ret)"].expanding(min_periods=1).sum())-1.0
+    #drdf[retname3]=np.exp(drdf["log(Daily Adj Ret)"].expanding(min_periods=1).sum())-1.0
+    first_aclose=drdf.head(1)['Adj Close'].values[0]
+    drdf[retname3]=drdf['Adj Close']/first_aclose-1
     drdf[retname4]=drdf[retname3]*100.0  
     
     return drdf
 
 if __name__ =="__main__":
     ticker='000002.SZ'
     basedate="2019-1-1"
@@ -1509,30 +1516,33 @@
 
 if __name__ =="__main__":
     period="Weekly"
     df=get_price('000002.SZ','2018-1-1','2020-3-16')
     vdf=rolling_price_volatility(df, period) 
 
 #==============================================================================
-def expanding_price_volatility(df,basedate):
+def expanding_price_volatility(df0,basedate):
     """
     功能：基于日价格数据集，从起始日期开始到结束日期调整价格风险的扩展窗口序列。
     输入：
     日价格数据集df。
     输出：期间扩展调整价格风险序列，按照日期升序排列。
     """
+    import pandas as pd
+    basedate_pd=pd.to_datetime(basedate)
+    df=df0[df0.index >= basedate_pd]
     
     #计算扩展窗口调整价格风险：基于收盘价
     retname1="Exp Price Volatility"
     import numpy as np
-    df[retname1]=df[df.index >= basedate]["Close"].expanding(min_periods=1).apply(lambda x: np.std(x,ddof=1)/np.mean(x)*np.sqrt(len(x)))
+    df[retname1]=df["Close"].expanding(min_periods=1).apply(lambda x: np.std(x,ddof=1)/np.mean(x)*np.sqrt(len(x)))
     
     #计算扩展窗口调整价格风险：基于调整收盘价
     retname3="Exp Adj Price Volatility"
-    df[retname3]=df[df.index >= basedate]["Adj Close"].expanding(min_periods=1).apply(lambda x: np.std(x,ddof=1)/np.mean(x)*np.sqrt(len(x)))
+    df[retname3]=df["Adj Close"].expanding(min_periods=1).apply(lambda x: np.std(x,ddof=1)/np.mean(x)*np.sqrt(len(x)))
     
     return df
 
 if __name__ =="__main__":
     df=get_price('000002.SZ','2018-1-1','2020-3-16')    
     evdf=expanding_price_volatility(df)  
 
@@ -1576,33 +1586,40 @@
 if __name__ =="__main__":
     period="Weekly"
     pricedf=get_price('000002.SZ','2018-1-1','2020-3-16')
     retdf=calc_daily_return(pricedf)
     vdf=rolling_ret_volatility(retdf, period) 
 
 #==============================================================================
-def expanding_ret_volatility(df,basedate):
+def expanding_ret_volatility(df0,basedate):
     """
     功能：基于日收益率数据集，从起始日期basedate开始的收益率波动风险扩展窗口序列。
     输入：
     日收益率数据集df。
     输出：扩展调整收益率波动风险序列，按照日期升序排列。
     """
+    df0["Daily Ret"]=df0['Close'].pct_change()
+    df0["Daily Adj Ret"]=df0['Adj Close'].pct_change()
+    
+    import pandas as pd
+    basedate_pd=pd.to_datetime(basedate)
+    df=df0[df0.index >= basedate_pd]
     
     #计算扩展窗口调整收益率波动风险：基于普通收益率
     retname1="Exp Ret Volatility"
     retname2="Exp Ret Volatility%"
     import numpy as np
-    df[retname1]=df[df.index >= basedate]["Daily Ret"].expanding(min_periods=1).apply(lambda x: np.std(x,ddof=1)*np.sqrt(len(x)))
+    
+    df[retname1]=df["Daily Ret"].expanding(min_periods=1).apply(lambda x: np.std(x,ddof=1)*np.sqrt(len(x)))
     df[retname2]=df[retname1]*100.0
     
     #计算扩展窗口调整收益率风险：基于调整收益率
     retname3="Exp Adj Ret Volatility"
     retname4="Exp Adj Ret Volatility%"
-    df[retname3]=df[df.index >= basedate]["Daily Adj Ret"].expanding(min_periods=1).apply(lambda x: np.std(x,ddof=1)*np.sqrt(len(x)))
+    df[retname3]=df["Daily Adj Ret"].expanding(min_periods=1).apply(lambda x: np.std(x,ddof=1)*np.sqrt(len(x)))
     df[retname4]=df[retname3]*100.0
     
     return df
 
 if __name__ =="__main__":
     basedate='2019-1-1'
     pricedf=get_price('000002.SZ','2018-1-1','2020-3-16')    
@@ -1683,33 +1700,39 @@
 if __name__ =="__main__":
     period="Weekly"
     pricedf=get_price('000002.SZ','2018-1-1','2020-3-16')
     retdf=calc_daily_return(pricedf)
     vdf=rolling_ret_lpsd(retdf, period) 
 
 #==============================================================================
-def expanding_ret_lpsd(df,basedate):
+def expanding_ret_lpsd(df0,basedate):
     """
     功能：基于日收益率数据集，从起始日期basedate开始的收益率损失风险扩展窗口序列。
     输入：
     日收益率数据集df。
     输出：扩展调整收益率波动风险序列，按照日期升序排列。
     """
+    df0["Daily Ret"]=df0['Close'].pct_change()
+    df0["Daily Adj Ret"]=df0['Adj Close'].pct_change()
+    
+    import pandas as pd
+    basedate_pd=pd.to_datetime(basedate)
+    df=df0[df0.index >= basedate_pd]
     
     #计算扩展窗口调整收益率下偏标准差：基于普通收益率
     retname1="Exp Ret LPSD"
     retname2=retname1+'%'
     import numpy as np
-    df[retname1]=df[df.index >= basedate]["Daily Ret"].expanding(min_periods=1).apply(lambda x: lpsd(x)*np.sqrt(len(x)))
+    df[retname1]=df["Daily Ret"].expanding(min_periods=1).apply(lambda x: lpsd(x)*np.sqrt(len(x)))
     df[retname2]=df[retname1]*100.0
     
     #计算扩展窗口调整下偏标准差：基于调整收益率
     retname3="Exp Adj Ret LPSD"
     retname4=retname3+'%'
-    df[retname3]=df[df.index >= basedate]["Daily Adj Ret"].expanding(min_periods=1).apply(lambda x: lpsd(x)*np.sqrt(len(x)))
+    df[retname3]=df["Daily Adj Ret"].expanding(min_periods=1).apply(lambda x: lpsd(x)*np.sqrt(len(x)))
     df[retname4]=df[retname3]*100.0
     
     return df
 
 if __name__ =="__main__":
     basedate='2019-1-1'
     pricedf=get_price('000002.SZ','2018-1-1','2020-3-16')
```

## siat/stock.py

```diff
@@ -474,17 +474,23 @@
         collabel=ectranslate(pricetype)
         ylabeltxt=collabel
         plot_line(df1,pricetype,collabel,ylabeltxt,titletxt,footnote,datatag=datatag,power=power)
     
     return df
 
 if __name__ =="__main__":
-    priceinfo=stock_price("000002.SZ","2020-2-1","2020-3-10",power=3)
+    priceinfo=stock_price("AAPL","2023-1-1","2023-6-16",power=3)
 
 #==============================================================================
+if __name__ =="__main__":
+    fromdate='2023-1-1'
+    fromdate1=date_adjust(fromdate,adjust=-730)
+    pricedf=get_price("AAPL",fromdate1,'2023-6-16')
+
+
 def ret_calculate(pricedf,fromdate):
     """
     功能：单纯计算各种收益率指标
     """
     #加入日收益率
     drdf=calc_daily_return(pricedf)
     #加入滚动收益率
@@ -497,31 +503,102 @@
     erdf=calc_expanding_return(prdf4,fromdate)
 
     return erdf
 
 def all_calculate(pricedf,ticker1,fromdate,todate):
     """
     功能：单纯计算所有基于证券价格的指标
+    
+    注意：对于滚动指标，起始日期需要提前至少一年以上
     """
     
     #计算其各种期间的收益率
     df1a=ret_calculate(pricedf,fromdate)
 
     #加入价格波动指标
-    df1b=price_volatility2(df1a,ticker1,fromdate,todate,graph=False)
+    #df1b=price_volatility2(df1a,ticker1,fromdate,todate,graph=False)
+    df1b=price_volatility2(pricedf,ticker1,fromdate,todate,graph=False)
 
     #加入收益率波动指标
-    df1c=ret_volatility2(df1b,ticker1,fromdate,todate,graph=False)
+    df1c=ret_volatility2(pricedf,ticker1,fromdate,todate,graph=False)
 
     #加入收益率下偏标准差指标
-    df1d=ret_lpsd2(df1c,ticker1,fromdate,todate,graph=False)
+    df1d=ret_lpsd2(pricedf,ticker1,fromdate,todate,graph=False)
+    
+    # 横向拼接合并
+    result=pd.concat([df1a,df1b,df1c,df1d],axis=1,join='outer')
+    
+    # 去掉重复的列
+    result1=result.T
+    result2=result1.drop_duplicates(subset=None,keep='first',ignore_index=False)
+    result3=result2.T
 
-    return df1d
+    return result3
+
+
+if __name__ =="__main__":
+    ticker1='NVDA'
+    fromdate='2023-5-1'
+    todate='2023-6-16'
+    rtype="Exp Ret%"
+    rtype="Annual Ret Volatility%"
+    
+    datatag=False
+    power=0
+    graph=True
 
-def stock_ret(ticker,fromdate,todate,rtype="Daily Ret%",datatag=False,power=4,graph=True):
+def security_indicator(ticker,fromdate,todate,rtype="Daily Ret%",datatag=False,power=0,graph=True):
+    """
+    功能：单只证券的全部指标
+    """
+    fromdate1=date_adjust(fromdate,adjust=-365*3)
+    
+    pricedf=get_price(ticker,fromdate1,todate)
+    if pricedf is None:
+        print("  #Error(security_indicator): security info not found for",ticker)
+        return None
+    
+    erdf=all_calculate(pricedf,ticker,fromdate,todate)
+    
+    import pandas as pd
+    fromdate_pd=pd.to_datetime(fromdate)
+    erdf2=erdf[erdf.index >= fromdate_pd]
+    
+    # 若rtype为Exp Ret%类指标，此处需要首行置零
+    colList=list(erdf2)
+    index1=erdf2.head(1).index.values[0]
+    for c in colList:
+        if 'Exp Ret%' in c:
+            erdf2.loc[erdf2[erdf2.index==index1].index.tolist(),c]=0
+    
+    #erdf3=pd.DataFrame(erdf2[rtype])
+    erdf3=erdf2
+
+    # 绘图
+    if not graph:
+        return erdf3
+    
+    titletxt=texttranslate("证券指标运动趋势：")+codetranslate(ticker)
+    import datetime; today = datetime.date.today()
+    footnote=texttranslate("数据来源：新浪/东方财富/stooq/雅虎财经，")+str(today)
+    collabel=ectranslate(rtype)
+    ylabeltxt=ectranslate(rtype)
+    
+    if 'Ret%' in rtype:
+        zeroline=True
+    else:
+        zeroline=False
+        
+    plot_line(erdf3,rtype,collabel,ylabeltxt,titletxt,footnote,datatag=datatag, \
+              power=power,zeroline=zeroline)
+    
+    return erdf3
+    
+    
+def stock_ret(ticker,fromdate,todate,rtype="Daily Ret%",datatag=False,power=0,graph=True):
     """
     功能：绘制证券收益率折线图。
     输入：证券代码ticker；开始日期fromdate，结束日期todate；收益率类型type；
     是否标注数据标签datatag，默认否；多项式趋势线的阶数，若为0则不绘制趋势线。
     输出：绘制证券价格折线图
     返回：证券价格数据表
     """
@@ -541,15 +618,15 @@
     drdf=calc_daily_return(pricedf)
     #加入滚动收益率
     prdf1=calc_rolling_return(drdf, "Weekly") 
     prdf2=calc_rolling_return(prdf1, "Monthly")
     prdf3=calc_rolling_return(prdf2, "Quarterly")
     prdf4=calc_rolling_return(prdf3, "Annual") 
     
-    #加入扩展收益率
+    #加入扩展收益率：从fromdate开始而不是fromdate1
     erdf=calc_expanding_return(prdf4,fromdate)
     
     #如果不绘图则直接返回数据表
     if not graph: return erdf    
     
     #获得支持的收益率类型列名
     colnames=list(erdf)
@@ -557,17 +634,17 @@
         colnames.remove(c)
     
     #检查type是否在支持的收益率列名中
     if not (rtype in colnames):
         print("  #Error(stock_ret)：only support return types of",colnames)
         return        
 
-    titletxt=texttranslate("证券收益率走势图：")+codetranslate(ticker)
+    titletxt=texttranslate("证券指标运动趋势：")+codetranslate(ticker)
     import datetime; today = datetime.date.today()
-    footnote=texttranslate("数据来源：新浪/东方财富/stooq，")+str(today)
+    footnote=texttranslate("数据来源：新浪/东方财富/stooq/雅虎财经，")+str(today)
     collabel=ectranslate(rtype)
     ylabeltxt=ectranslate(rtype)
     pltdf=erdf[erdf.index >= fromdate]
     plot_line(pltdf,rtype,collabel,ylabeltxt,titletxt,footnote,datatag=datatag, \
               power=power,zeroline=True)
     
     return erdf
@@ -878,15 +955,15 @@
     datatag=False
     power=3
 
     pv=ret_lpsd("000002.SZ","2019-1-1","2020-3-16","Annual Ret Volatility%")
     pv=ret_lpsd("000002.SZ","2019-1-1","2020-3-16","Annual Exp Ret Volatility%")
 
 #==============================================================================
-def ret_lpsd2(retdf,ticker,fromdate,todate,type="Weekly Ret Volatility%",datatag=False,power=4,graph=True):
+def ret_lpsd2(retdf,ticker,fromdate,todate,rtype="Weekly Ret Volatility%",datatag=False,power=4,graph=True):
     """
     功能：绘制证券收益率波动损失风险折线图。与函数ret_lpsd的唯一区别是不抓取股价。
     输入：股价数据集pricedf；证券代码ticker；开始日期fromdate，结束日期todate；期间类型type；
     是否标注数据标签datatag，默认否；多项式趋势线的阶数，若为0则不绘制趋势线。
     输出：绘制证券收益率下偏标准差折线图。
     返回：证券收益率下偏标准差数据表。
     """
@@ -906,25 +983,25 @@
     
     #获得支持的价格波动风险类型列名，去掉不需要的列名
     colnames=list(erdf)
     for c in retdfcols:
         colnames.remove(c)
     
     #检查type是否在支持的收益率列名中
-    if not (type in colnames):
+    if not (rtype in colnames):
         print("  #Error(ret_lpsd2): only support return risk types of",colnames)
         return        
 
     titletxt=texttranslate("证券收益率波动损失风险走势图：")+codetranslate(ticker)
     import datetime; today = datetime.date.today()
     footnote=texttranslate("数据来源：新浪/东方财富/stooq，")+str(today)
-    collabel=ectranslate(type)
-    ylabeltxt=ectranslate(type)
+    collabel=ectranslate(rtype)
+    ylabeltxt=ectranslate(rtype)
     pltdf=erdf[erdf.index >= fromdate]
-    plot_line(pltdf,type,collabel,ylabeltxt,titletxt,footnote,datatag=datatag, \
+    plot_line(pltdf,rtype,collabel,ylabeltxt,titletxt,footnote,datatag=datatag, \
               power=power,zeroline=True)
     
     return erdf
 
 if __name__ =="__main__":
     ticker="000002.SZ"
     fromdate="2020-1-1"
@@ -1222,27 +1299,29 @@
     tickers=["AMZN","EBAY","SHOP","BABA","JD"]
     tickers=["AMZN","EBAY","SHOP","BABA","JD","PDD"]
     tickers=['000001.SS',"399001.SZ","000300.SS"]
     tickers=['000001.SS','^N225','^KS11']
     measure="Annual Ret%"
     measure="Exp Ret%"
     measure="Close"
+    measure="Annual Ret Volatility%"
+    
     start="2020-1-1"
     end="2022-7-31"
     
     preprocess='scaling'
     linewidth=1.5
     scaling_option='start'
     
 def compare_msecurity(tickers,measure,start,end, \
                       axhline_value=0,axhline_label='', \
                       preprocess='none',linewidth=1.5, \
                       scaling_option='start', \
                       graph=True,loc='best', \
-                      annotate=False):
+                      annotate=False,smooth=False):
     """
     功能：比较并绘制多条证券指标曲线（多于2条），个数可为双数或单数
     注意：
     tickers中须含有2个及以上股票代码，
     measure为单一指标，
     axhline_label不为空时绘制水平线
     
@@ -1252,45 +1331,64 @@
         normalize: 归一化处理，(x - min(x))/(max(x) - min(x))
         logarithm: 对数处理，np.log(x)
         scaling：缩放处理，三种选项scaling_option（mean均值，min最小值，start开始值）
         start方式的图形更接近于持有收益率(Exp Ret%)，设为默认的缩放方式。
     
     """
     tickers=upper_ticker(tickers)
-    
     # 去掉重复代码
     tickers=list(set(tickers))
-    
     num=len(tickers)
     if num <2:
         print("  #Error(compare_msecurity): need more tickers")
         return None
 
     if not isinstance(measure,str): 
         print("  #Error(compare_msecurity): support only one measure")
         return None
     
-    print("Searching for multiple security information for",measure,"\b, please wait ...") 
+    print("Searching for multiple security information for",measure,"\b, it takes great time, please wait ...") 
     #屏蔽函数内print信息输出的类
     import os, sys
     class HiddenPrints:
         def __enter__(self):
             self._original_stdout = sys.stdout
             sys.stdout = open(os.devnull, 'w')
 
         def __exit__(self, exc_type, exc_val, exc_tb):
             sys.stdout.close()
             sys.stdout = self._original_stdout
     
     #循环获取证券指标
-    loopn=int(len(tickers)/2)
-    colname=''
     import pandas as pd
-    dfs=pd.DataFrame()
     from functools import reduce
+
+    dfs=pd.DataFrame()
+    for t in tickers:
+        print("  Looking security info for",t,'...')
+        with HiddenPrints():
+            df_tmp=security_indicator(t,start,end,rtype=measure,graph=False)
+        if df_tmp is None:
+            print("  #Warning(compare_msecurity): security info not found for",t)
+            continue
+        if len(df_tmp)==0:
+            print("  #Warning(compare_msecurity): security info not found for",t,'between',start,'and',end)
+            continue
+        
+        df_tmp1=pd.DataFrame(df_tmp[measure])
+        df_tmp1.rename(columns={measure:codetranslate(t)},inplace=True)     
+        if len(dfs)==0:
+            dfs=df_tmp1
+        else:
+            dfs=pd.concat([dfs,df_tmp1],axis=1,join='outer')
+            
+    
+    """    
+    loopn=int(len(tickers)/2)
+    colname=''
     for i in range(0,loopn):
         pair=tickers[i*2:i*2+2]
         #print(i,pair)
         with HiddenPrints():
             dfi=compare_security(pair,measure,start,end,graph=False)
 
         dfi1=dfi[0]
@@ -1359,14 +1457,15 @@
         # 去掉时区信息，避免合并中的日期时区冲突问题
         import pandas as pd
         dfi1.index = pd.to_datetime(dfi1.index)
         dfi1.index = dfi1.index.tz_localize(None)
         
         dflist=[dfs,dfi1]
         dfs=reduce(lambda left,right:pd.merge(left,right,how='outer',left_index=True,right_index=True),dflist)
+    """
 
     # 若不绘图则返回
     if not graph:
         return dfs
 
     #绘制多条曲线
     y_label=ectranslate(measure)
@@ -1492,41 +1591,60 @@
     dfs2.fillna(axis=0,method='ffill',inplace=True)
     dfs2.fillna(axis=0,method='bfill',inplace=True)
 
     if 'Ret%' in measure:
         if axhline_label=='':
             axhline_label='收益零线'
 
+    #持有类指标的首行置为零
+    colList=list(dfs2)
+    index1=dfs2.head(1).index.values[0]
+    for c in colList:
+        if 'Exp Ret%' in c:
+            dfs2.loc[dfs2[dfs2.index==index1].index.tolist(),c]=0
+
     draw_lines(dfs2,y_label,x_label,axhline_value,axhline_label,title_txt, \
-               data_label=False,resample_freq='H',smooth=True,linewidth=linewidth,loc=loc, \
+               data_label=False,resample_freq='H',smooth=smooth,linewidth=linewidth,loc=loc, \
                annotate=annotate)
 
     return dfs2
 
 if __name__ =="__main__":
     tickers=['000001.SS',"^HSI","^TWII"]
     df=compare_msecurity(tickers,'Close','2020-1-1','2022-12-14',preprocess='standardize')
     df=compare_msecurity(tickers,'Close','2020-1-1','2022-12-14',preprocess='normalize')
     df=compare_msecurity(tickers,'Close','2020-1-1','2022-12-14',preprocess='logarithm')
     df=compare_msecurity(tickers,'Close','2020-1-1','2022-12-14',preprocess='scaling')
 
 #==============================================================================
 if __name__ =="__main__":
-    tickers=['AAPL','MSFT','QCOM']
-    start='2022-1-1'
-    end='2022-12-31'
+    tickers=['JD','BABA','BIDU','VIPS','PDD']
+    start='2023-5-1'
+    end='2023-6-16'
     ret_measure='Exp Ret%'
+    ret_measure='Annual Ret%'
+    
     risk_type='Volatility'
+    annotate=True
     graph=True
+    smooth=False
     
     
-def compare_mrrr(tickers,start,end,ret_measure='Exp Ret%',risk_type='Volatility',graph=True):
+def compare_mrrr(tickers,start,end,ret_measure='Exp Ret%',risk_type='Volatility', \
+                 annotate=False,graph=True,smooth=False,winsorize_limits=[0.05,0.05]):
     """
-    功能：比较多个证券的简单收益-风险性价比，基于compare_msecurity
+    功能：rrr = return-risk ratio
+    比较多个证券的简单收益-风险性价比，基于compare_msecurity
+    ret_measure='Exp Ret%'：可以为持有收益率，或滚动收益率
+    risk_type='Volatility'：可以为标准差，或下偏标准差
+    
+    winsorize_limits=[0.05,0.05]：去掉最低的5%（第一个参数），去掉最高的5%（第二个参数）
     """    
+    #print("Searching for return-risk performance based on",ret_measure,"it takes great time, please wait ...")
+    
     try:
         df_ret=compare_msecurity(tickers,ret_measure,start,end,graph=False)
     except:
         return None
     cols=list(df_ret)
     
     risk_measure=ret_measure[:-1]+' '+risk_type+'%'
@@ -1540,46 +1658,46 @@
     #df.fillna(axis=0,method='ffill',inplace=True)
     #df.fillna(axis=0,method='bfill',inplace=True)
     
     for c in cols:
         df[c]=df[c+'_x']/df[c+'_y']
         
     df2=df[cols]
+    
+    from scipy.stats.mstats import winsorize
+    # 若,ret_measure为Exp类指标，此处需要首行置零
+    colList=list(df2)
+    index1=df2.head(1).index.values[0]
+    for c in colList:
+        if 'Exp' in ret_measure:
+            df2.loc[df2[df2.index==index1].index.tolist(),c]=0
+        
+        # 缩尾处理：先转换为数值类型，以防万一
+        df2[c]=df2[c].astype('float')
+        df2[c]=winsorize(df2[c],limits=winsorize_limits)
+            
+    #df2.interpolate(method='polynomial',order=2,axis=0,inplace=True)
 
     y_label="收益-风险性价比"
     
     measure1=ectranslate(ret_measure)[:-1]
     measure2=ectranslate(risk_measure)[:-1]
     footnote1="注：图中的收益-风险性价比定义为"+measure1+"与"+measure2+"之比"
     import datetime; today = datetime.date.today()    
     footnote2="数据来源：新浪财经/雅虎财经/stooq，"+str(today)
     x_label=footnote1+"\n"+footnote2
     
-    title_txt="比较多只证券的收益-风险性价比"
+    title_txt="比较多只证券的简单收益-风险性价比"
     
+    print("Rendering for illustration, please wait ...")
     draw_lines(df2,y_label,x_label,axhline_value=0,axhline_label='',title_txt=title_txt, \
-               data_label=False,resample_freq='D')
+               data_label=False,resample_freq='D',smooth=smooth,annotate=annotate)
 
     return df2
         
-    
-    
-    
-
-
-
-
-
-
-
-
-
-
-
-
 
 #==============================================================================
 if __name__ =="__main__":
     tickers1=["AMZN","EBAY","SHOP","BABA","JD"]
     tickers2=["AMZN","EBAY","SHOP","BABA","JD","PDD"]
     measure1="Annual Ret%"
     measure2="Exp Ret%"
```

## Comparing `siat-2.1.5.dist-info/METADATA` & `siat-2.1.6.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: siat
-Version: 2.1.5
+Version: 2.1.6
 Summary: Securities Investment Analysis Tools (siat)
 Home-page: https://pypi.org/project/siat/
 Author: Prof. WANG Dehong, Business School, BFSU (北京外国语大学 国际商学院 王德宏 教授)
 Author-email: wdehong2000@163.com
 License: Copyright (C) WANG Dehong, 2023. For educational purpose only!
 Platform: UNKNOWN
 Requires-Dist: pandas-datareader
```

## Comparing `siat-2.1.5.dist-info/RECORD` & `siat-2.1.6.dist-info/RECORD`

 * *Files 7% similar despite different names*

```diff
@@ -50,15 +50,15 @@
 siat/fund_china.pickle,sha256=hsPjNAQtvCMTPQV5lFk3sS7cngetWaxFvdyEtNvnU14,2047492
 siat/fund_china.py,sha256=UOYUGxYdRV0i4VNqzROHxD65K6dyd-U4zKagkUTTAuk,74734
 siat/fund_china_test.py,sha256=-Bh6m0J0GPpIbYXx-H2vpzJoNFI6pE2C2jVPa8DazgE,6649
 siat/fund_test.py,sha256=V4ADb8Gsp8gyeFTwcgRsJBpnUih_O-Q2V1ILc5oKjK8,1116
 siat/future_china.py,sha256=PCHpxxC-eBDo3P_nkSeQzMnVCt-H7YAZEDJcxfkdnuU,17513
 siat/future_china_test.py,sha256=BrSzmDVaOHki6rntOtosmRn-6dkfOBuLulJNqh7MOpc,1163
 siat/global_index_test.py,sha256=hnFp3wqqzzL-kAP8mgxDZ54Bd5Ijf6ENi5YJlGBgcXw,2402
-siat/grafix.py,sha256=SslCHur0_9TIIV75kLabaFX8V4LARoH-CldwA0ZDcwo,64367
+siat/grafix.py,sha256=Xwh_BMs4C_HpoTy4hdHOflwEVBUmzK9hgfWgRQ0v8VA,65659
 siat/grafix_test.py,sha256=kXvcpLgQNO7wd30g_bWljLj5UH7bIVI0_dUtXbfiKR0,3150
 siat/holding_risk.py,sha256=108tiI7DDl8uUZkyUiq6Y-McKeim1mxYsgqgk7CcXw8,30544
 siat/holding_risk_test.py,sha256=FRlw_9wFG98BYcg_cSj95HX5WZ1TvkGaOUdXD7-V86s,474
 siat/local_debug_test.py,sha256=CDAOffW1Rvs-TcNN5giWVvHMlch1w4dp-w5SIV9jXL0,3936
 siat/market_china.py,sha256=2_ov1KQwRtHQ6PXNO1TS4-wUPhBuoWla326g0x_xUgQ,31158
 siat/markowitz.py,sha256=g3P-UripHV_VwtQetdGaPtfmRsFUxQICqmtF4Pp6C3k,95641
 siat/markowitz_ccb_test.py,sha256=xBkkoaNHdq9KSUrNuHGgKTdNYUvgi84kNYcf719eoyE,1593
@@ -80,19 +80,19 @@
 siat/risk_evaluation.py,sha256=lCDqCaSEppH0MFPFg-P14IYcF3IJqILbPfDmzf_AfcY,75061
 siat/risk_evaluation_test.py,sha256=YEXM96gKzTfwN4U61AS4Rr1tV7KgUvn4rRC6f3iMw9s,3731
 siat/risk_free_rate.py,sha256=r62zCl1qbI4lJU17GsgM-OmVx9oo3dltXeZVCNd6Uxg,12304
 siat/risk_free_rate_test.py,sha256=CpmhUf8aEAEZeNu4gvWP2Mz2dLoIgBX5bI41vfUBEr8,4285
 siat/sector_china.py,sha256=sHd7nlYWCK0SWAZbu-BLn-3vNPe2E8OFaDFYF67Hoho,101523
 siat/sector_china_test.py,sha256=1wq7ef8Bb_L8F0h0W6FvyBrIcBTEbrTV7hljtpj49U4,5843
 siat/security_price.py,sha256=2oHskgiw41KMGfqtnA0i2YjNNV6cYgtlUK0j3YeuXWs,29185
-siat/security_prices.py,sha256=xDK2HSsiyedQIvjcU56yZZCa9mnTNQfJfVWnx9ihPVs,72184
+siat/security_prices.py,sha256=aqAG7vuGMX6sXkNDyJN0uCU2G6b4lmM9Hq-wQbi-5dA,72866
 siat/security_prices_test.py,sha256=OEphoJ87NPKoNow1QA8EU_5MUYrJF-qKoWKNapVfZNI,10779
 siat/setup.py,sha256=up65rQGLmTBkhtaMLowjoQXYmIsnycnm4g1SYmeQS6o,1335
 siat/shenwan index history test.py,sha256=JCVAzOSEldHalhSFa3pqD8JI_8_djPMQOxpkuYU-Esg,1418
-siat/stock.py,sha256=swB1HjQhImaQ6zEsSHgiLODXFHUPYCbkU5Y6dCIaEvc,118820
+siat/stock.py,sha256=PocxcWbU8n209F_MaiqJhNIjYV1HJSENqLtmw4iZcXA,123451
 siat/stock_advice_linear.py,sha256=-twT7IGP-NEplkL1WPSACcNJjggRB2j4mlAQCkzOAuo,31655
 siat/stock_base.py,sha256=uISvbRyOGy8p9QREA96CVydgflBkn5L3OXOGKl8oanc,1312
 siat/stock_china.py,sha256=jVSuCWr6TaTx0Y0sgqN-dU9ZL72uKiI_MzvugvH9NaI,82785
 siat/stock_china_test.py,sha256=eO4HWsSvc6qezl0LndjtL24lViEyrBjH_sx2c2Y2Q2M,1294
 siat/stock_info.pickle,sha256=o4M-pcN8Sh8QiwZQAZWY1aelI4xgIGIxors7n2uHSJI,1266744
 siat/stock_info_test.py,sha256=gfG3DbhDACbtD8wnv_R6zhj0t11XaC8NX8uLD9Qv3Fo,6122
 siat/stock_list_china_test.py,sha256=gv14UwMMvkZqtb6G7DCTSuehIwVHuVwu7w60p6gyHoo,1014
@@ -110,11 +110,11 @@
 siat/translate-20230206.py,sha256=-vtI125WyaJhmPotOpDAmclt_XnYVaWU9ByLWZ6FyYE,118133
 siat/translate-20230215.py,sha256=TJgtPE3n8IjljmZ4Pefy8dmHoNdFF-1zpML6BhA9FKE,121657
 siat/translate.py,sha256=nS9gqygAkb-2M2utEjucdw-5kWe7hCrDW1OqX3sed7E,133928
 siat/universal_test.py,sha256=CDAOffW1Rvs-TcNN5giWVvHMlch1w4dp-w5SIV9jXL0,3936
 siat/valuation_china.py,sha256=gYYXeT9bBPyQ251TCsYlibWcu6JA8x-YOKqLUEeLE7U,51342
 siat/valuation_market_china_test.py,sha256=gbJ0ioauuo4koTPH6WKUkqcXiQPafnbhU5eKJ6lpdLA,1571
 siat/var_model_validation.py,sha256=zB_Skk_tmzIR15l6oAW3am4HBGVIG-eZ8gJhCdXZ8Qw,14859
-siat-2.1.5.dist-info/METADATA,sha256=l813XBKUMdV7LKxkkj9w92tLkcHooA-SNvcFocfZ2ts,1410
-siat-2.1.5.dist-info/WHEEL,sha256=ewwEueio1C2XeHTvT17n8dZUJgOvyCWCt0WVNLClP9o,92
-siat-2.1.5.dist-info/top_level.txt,sha256=r1cVyL7AIKqeAmEJjNR8FMT20OmEzufDstC2gv3NvEY,5
-siat-2.1.5.dist-info/RECORD,,
+siat-2.1.6.dist-info/METADATA,sha256=If5sbhDyhraDU7SCELGtjZkCAfp02CG2PKsjT7fBzB4,1410
+siat-2.1.6.dist-info/WHEEL,sha256=ewwEueio1C2XeHTvT17n8dZUJgOvyCWCt0WVNLClP9o,92
+siat-2.1.6.dist-info/top_level.txt,sha256=r1cVyL7AIKqeAmEJjNR8FMT20OmEzufDstC2gv3NvEY,5
+siat-2.1.6.dist-info/RECORD,,
```

