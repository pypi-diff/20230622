# Comparing `tmp/odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7-py3-none-any.whl.zip` & `tmp/odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,21 +1,21 @@
-Zip file size: 26114 bytes, number of entries: 19
--rw-r--r--  2.0 unx     3400 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/README.rst
--rw-r--r--  2.0 unx       21 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/__init__.py
--rw-r--r--  2.0 unx      557 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/__manifest__.py
--rw-r--r--  2.0 unx     3064 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/data/queue_job_data.xml
--rw-r--r--  2.0 unx     3097 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/i18n/it.po
--rw-r--r--  2.0 unx     2627 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/i18n/sale_automatic_workflow_job.pot
--rw-r--r--  2.0 unx       61 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/models/__init__.py
--rw-r--r--  2.0 unx     3342 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/models/automatic_workflow_job.py
--rw-r--r--  2.0 unx      575 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/models/queue_job.py
--rw-r--r--  2.0 unx      123 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx      658 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx     9455 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/static/description/icon.png
--rw-r--r--  2.0 unx    12725 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/static/description/index.html
--rw-r--r--  2.0 unx       37 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/tests/__init__.py
--rw-r--r--  2.0 unx     5629 b- defN 22-Jun-03 04:26 odoo/addons/sale_automatic_workflow_job/tests/test_auto_workflow_job.py
--rw-r--r--  2.0 unx     4068 b- defN 22-Jun-03 04:29 odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 22-Jun-03 04:29 odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 22-Jun-03 04:29 odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     2238 b- defN 22-Jun-03 04:29 odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/RECORD
-19 files, 51774 bytes uncompressed, 22202 bytes compressed:  57.1%
+Zip file size: 26729 bytes, number of entries: 19
+-rw-r--r--  2.0 unx     3400 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/README.rst
+-rw-r--r--  2.0 unx       21 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/__init__.py
+-rw-r--r--  2.0 unx      557 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/__manifest__.py
+-rw-r--r--  2.0 unx     3064 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/data/queue_job_data.xml
+-rw-r--r--  2.0 unx     3097 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/i18n/it.po
+-rw-r--r--  2.0 unx     2627 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/i18n/sale_automatic_workflow_job.pot
+-rw-r--r--  2.0 unx       61 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/models/__init__.py
+-rw-r--r--  2.0 unx     6778 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/models/automatic_workflow_job.py
+-rw-r--r--  2.0 unx      575 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/models/queue_job.py
+-rw-r--r--  2.0 unx      123 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx      658 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx     9455 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/static/description/icon.png
+-rw-r--r--  2.0 unx    12725 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/static/description/index.html
+-rw-r--r--  2.0 unx       37 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/tests/__init__.py
+-rw-r--r--  2.0 unx     6489 b- defN 23-Jun-22 08:12 odoo/addons/sale_automatic_workflow_job/tests/test_auto_workflow_job.py
+-rw-r--r--  2.0 unx     4063 b- defN 23-Jun-22 08:12 odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Jun-22 08:12 odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-Jun-22 08:12 odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     2218 b- defN 23-Jun-22 08:12 odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/RECORD
+19 files, 56045 bytes uncompressed, 22857 bytes compressed:  59.2%
```

## zipnote {}

```diff
@@ -39,20 +39,20 @@
 
 Filename: odoo/addons/sale_automatic_workflow_job/tests/__init__.py
 Comment: 
 
 Filename: odoo/addons/sale_automatic_workflow_job/tests/test_auto_workflow_job.py
 Comment: 
 
-Filename: odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/METADATA
+Filename: odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/METADATA
 Comment: 
 
-Filename: odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/WHEEL
+Filename: odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/WHEEL
 Comment: 
 
-Filename: odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/top_level.txt
+Filename: odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/RECORD
+Filename: odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/sale_automatic_workflow_job/__manifest__.py

```diff
@@ -1,14 +1,14 @@
 # Copyright 2020 Camptocamp (https://www.camptocamp.com)
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
 
 {
     "name": "Sale Automatic Workflow Job",
     "summary": "Execute sale automatic workflows in queue jobs",
-    "version": "14.0.1.0.0",
+    "version": "14.0.1.0.2",
     "category": "Sales Management",
     "license": "AGPL-3",
     "author": "Camptocamp, " "Odoo Community Association (OCA)",
     "website": "https://github.com/OCA/sale-workflow",
     "depends": ["sale_automatic_workflow", "queue_job"],
     "data": [
         "data/queue_job_data.xml",
```

## odoo/addons/sale_automatic_workflow_job/models/automatic_workflow_job.py

```diff
@@ -4,75 +4,156 @@
 
 from odoo.addons.queue_job.job import identity_exact
 
 
 class AutomaticWorkflowJob(models.Model):
     _inherit = "automatic.workflow.job"
 
-    def _do_validate_sale_order_job_options(self, sale, domain_filter):
+    def _do_validate_sale_order_job_options(
+        self, sale, domain_filter, send_order_confirmation=False
+    ):
         description = _("Validate sales order {}").format(sale.display_name)
         return {
             "description": description,
             "identity_key": identity_exact,
         }
 
     def _validate_sale_orders(self, domain_filter):
         with_context = self.with_context(auto_delay_do_validation=True)
         return super(AutomaticWorkflowJob, with_context)._validate_sale_orders(
             domain_filter
         )
 
+    def _do_validate_sale_order(
+        self, sale, domain_filter, send_order_confirmation=False
+    ):
+        """filter ensure no duplication"""
+        if not sale.exists():
+            return "Sale order does not exist"
+        if not self.env["sale.order"].search_count(
+            [("id", "=", sale.id)] + domain_filter
+        ):
+            return "{} {} job bypassed".format(sale.display_name, sale)
+        super()._do_validate_sale_order(sale, domain_filter, send_order_confirmation)
+        return "{} {} confirmed successfully {}".format(
+            sale.display_name,
+            sale,
+            "and confirmation email sent" if send_order_confirmation else "",
+        )
+
+    def _do_send_order_confirmation_mail(self, sale):
+        """Filtering to make sure the order is confirmed with
+        _do_validate_sale_order() function"""
+        if not sale.exists():
+            return "Sale order does not exist"
+        if not self.env["sale.order"].search_count(
+            [("id", "=", sale.id), ("state", "=", "sale")]
+        ):
+            return "{} {} job bypassed".format(sale.display_name, sale)
+        super()._do_send_order_confirmation_mail(sale)
+        return "{} {} send order confirmation mail successfully".format(
+            sale.display_name, sale
+        )
+
     def _do_create_invoice_job_options(self, sale, domain_filter):
         description = _("Create invoices for sales order {}").format(sale.display_name)
         return {
             "description": description,
             "identity_key": identity_exact,
         }
 
     def _create_invoices(self, domain_filter):
         with_context = self.with_context(auto_delay_do_create_invoice=True)
         return super(AutomaticWorkflowJob, with_context)._create_invoices(domain_filter)
 
+    def _do_create_invoice(self, sale, domain_filter):
+        """filter ensure no duplication"""
+        if not sale.exists():
+            return "Sale order does not exist"
+        if not self.env["sale.order"].search_count(
+            [("id", "=", sale.id)] + domain_filter
+        ):
+            return "{} {} job bypassed".format(sale.display_name, sale)
+        super()._do_create_invoice(sale, domain_filter)
+        return "{} {} create invoice successfully".format(sale.display_name, sale)
+
     def _do_validate_invoice_job_options(self, invoice, domain_filter):
         description = _("Validate invoice {}").format(invoice.display_name)
         return {
             "description": description,
             "identity_key": identity_exact,
         }
 
     def _validate_invoices(self, domain_filter):
         with_context = self.with_context(auto_delay_do_validation=True)
         return super(AutomaticWorkflowJob, with_context)._validate_invoices(
             domain_filter
         )
 
+    def _do_validate_invoice(self, invoice, domain_filter):
+        """filter ensure no duplication"""
+        if not invoice.exists():
+            return "Invoice does not exist"
+        if not self.env["account.move"].search_count(
+            [("id", "=", invoice.id)] + domain_filter
+        ):
+            return "{} {} job bypassed".format(invoice.display_name, invoice)
+        super()._do_validate_invoice(invoice, domain_filter)
+        return "{} {} validate invoice successfully".format(
+            invoice.display_name, invoice
+        )
+
     def _do_validate_picking_job_options(self, picking, domain_filter):
         description = _("Validate transfer {}").format(picking.display_name)
         return {
             "description": description,
             "identity_key": identity_exact,
         }
 
     def _validate_pickings(self, domain_filter):
         with_context = self.with_context(auto_delay_do_validation=True)
         return super(AutomaticWorkflowJob, with_context)._validate_pickings(
             domain_filter
         )
 
+    def _do_validate_picking(self, picking, domain_filter):
+        """filter ensure no duplication"""
+        if not picking.exists():
+            return "Picking does not exist"
+        if not self.env["stock.picking"].search_count(
+            [("id", "=", picking.id)] + domain_filter
+        ):
+            return "{} {} job bypassed".format(picking.display_name, picking)
+        super()._do_validate_picking(picking, domain_filter)
+        return "{} {} validate picking successfully".format(
+            picking.display_name, picking
+        )
+
     def _do_sale_done_job_options(self, sale, domain_filter):
         description = _("Mark sales order {} as done").format(sale.display_name)
         return {
             "description": description,
             "identity_key": identity_exact,
         }
 
     def _sale_done(self, domain_filter):
         with_context = self.with_context(auto_delay_do_sale_done=True)
         return super(AutomaticWorkflowJob, with_context)._sale_done(domain_filter)
 
+    def _do_sale_done(self, sale, domain_filter):
+        """filter ensure no duplication"""
+        if not sale.exists():
+            return "Sale order does not exist"
+        if not self.env["sale.order"].search_count(
+            [("id", "=", sale.id)] + domain_filter
+        ):
+            return "{} {} job bypassed".format(sale.display_name, sale)
+        super()._do_sale_done(sale, domain_filter)
+        return "{} {} set done successfully".format(sale.display_name, sale)
+
     def _register_hook(self):
         mapping = {
             "_do_validate_sale_order": "auto_delay_do_validation",
             "_do_create_invoice": "auto_delay_do_create_invoice",
             "_do_validate_invoice": "auto_delay_do_validation",
             "_do_validate_picking": "auto_delay_do_validation",
             "_do_sale_done": "auto_delay_do_sale_done",
```

## odoo/addons/sale_automatic_workflow_job/tests/test_auto_workflow_job.py

```diff
@@ -1,14 +1,15 @@
 # Copyright 2020 Camptocamp (https://www.camptocamp.com)
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
 
 from odoo.tests import tagged
+from odoo.tools.safe_eval import safe_eval
 
 from odoo.addons.queue_job.job import identity_exact
-from odoo.addons.queue_job.tests.common import mock_with_delay
+from odoo.addons.queue_job.tests.common import mock_with_delay, trap_jobs
 from odoo.addons.sale_automatic_workflow.tests.common import (
     TestAutomaticWorkflowMixin,
     TestCommon,
 )
 
 
 @tagged("post_install", "-at_install")
@@ -40,14 +41,15 @@
             self.run_job()  # run automatic workflow cron
             args = (
                 self.sale,
                 [
                     ("state", "=", "draft"),
                     ("workflow_process_id", "=", self.sale.workflow_process_id.id),
                 ],
+                False,
             )
             self.assert_job_delayed(
                 delayable_cls, delayable, "_do_validate_sale_order", args
             )
 
     def test_create_invoice(self):
         workflow = self.create_full_automatic()
@@ -132,7 +134,27 @@
                 [
                     ("state", "=", "sale"),
                     ("invoice_status", "=", "invoiced"),
                     ("workflow_process_id", "=", self.sale.workflow_process_id.id),
                 ],
             )
             self.assert_job_delayed(delayable_cls, delayable, "_do_sale_done", args)
+
+    def test_deleted_sale_order(self):
+        workflow = self.create_full_automatic()
+        workflow_domain = [("workflow_process_id", "=", workflow.id)]
+        self.sale = self.create_sale_order(workflow)
+        with trap_jobs() as trap:
+            self.run_job()
+            trap.assert_jobs_count(1)
+            trap.assert_enqueued_job(
+                self.env["automatic.workflow.job"]._do_validate_sale_order,
+                args=(
+                    self.sale,
+                    safe_eval(workflow.order_filter_id.domain) + workflow_domain,
+                    False,
+                ),
+            )
+            job = trap.enqueued_jobs[0]
+            self.assertEqual(job.state, "pending")
+            self.sale.unlink()
+            trap.perform_enqueued_jobs()
```

## Comparing `odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/METADATA` & `odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/METADATA`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: odoo14-addon-sale-automatic-workflow-job
-Version: 14.0.1.0.1.dev7
+Version: 14.0.1.0.2
 Summary: Execute sale automatic workflows in queue jobs
 Home-page: https://github.com/OCA/sale-workflow
 Author: Camptocamp, Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
```

## Comparing `odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/RECORD` & `odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/RECORD`

 * *Files 21% similar despite different names*

```diff
@@ -1,19 +1,19 @@
 odoo/addons/sale_automatic_workflow_job/README.rst,sha256=0qrzwZI9qWD2zaxztnA_dggI56IG-pTJO3ZH8oc_xtc,3400
 odoo/addons/sale_automatic_workflow_job/__init__.py,sha256=X9EJGOE2GtZbS0G82PtSXmWSZ_R8jEM0rlJTDliQjp4,21
-odoo/addons/sale_automatic_workflow_job/__manifest__.py,sha256=g5DUpKqmg8Vqtb3XrF_L2whuloa5It1zq4XE5-uSSyE,557
+odoo/addons/sale_automatic_workflow_job/__manifest__.py,sha256=4eWwLlEZKrie2oLLVtaeRvKSaV8Xh6pozaLxLKK6jy0,557
 odoo/addons/sale_automatic_workflow_job/data/queue_job_data.xml,sha256=Kdjom9LEvlhFzwajgxtzaXw8KARDz460JOSG9d6LXSo,3064
 odoo/addons/sale_automatic_workflow_job/i18n/it.po,sha256=Dz_eVSBeOgYdK_0x2llvE24tyUL-9VfniZcJMNLIfyQ,3097
 odoo/addons/sale_automatic_workflow_job/i18n/sale_automatic_workflow_job.pot,sha256=Qv_j_b707se70ZHkL3jY7N5OyQXz9XEE5MRMtC5ZL7o,2627
 odoo/addons/sale_automatic_workflow_job/models/__init__.py,sha256=dv9raOIn1zoEYIa0uh3qmbc22DGvNzZv16BeQpjPVAA,61
-odoo/addons/sale_automatic_workflow_job/models/automatic_workflow_job.py,sha256=YvtiRiyqBB43k3dRFL3zNW-3GeVAXmONJZ5oTLOYLug,3342
+odoo/addons/sale_automatic_workflow_job/models/automatic_workflow_job.py,sha256=5LWkDCGok9k0E7jyg7kzhXhyQni0PHxTWft0T0aYIF4,6778
 odoo/addons/sale_automatic_workflow_job/models/queue_job.py,sha256=J6u1DKx6RC2Kr1-gkf_7S2a7lrJTjfYrE0NU0w1uHpk,575
 odoo/addons/sale_automatic_workflow_job/readme/CONTRIBUTORS.rst,sha256=2vlypNZa3IEDe1ctwBVq-uke8CQOrHeLI_cZ1PsMwOY,123
 odoo/addons/sale_automatic_workflow_job/readme/DESCRIPTION.rst,sha256=EW1RHGENjQhl_GUCgmJyCuqrIWIaE8qX6CweVvlBO9U,658
 odoo/addons/sale_automatic_workflow_job/static/description/icon.png,sha256=6xBPJauaFOF0KDHfHgQopSc28kKvxMaeoQFQWZtfZDo,9455
 odoo/addons/sale_automatic_workflow_job/static/description/index.html,sha256=4l-5FhwxgJr6jHL-QYK8qGletbKM0V3cWijamfJHbsE,12725
 odoo/addons/sale_automatic_workflow_job/tests/__init__.py,sha256=vqwQlfL95ZvrsndkbpSMavxaxa0TSExlwfSq74P-6ow,37
-odoo/addons/sale_automatic_workflow_job/tests/test_auto_workflow_job.py,sha256=o_QTSYX7G4wTGStqMc2gim_AevSIgRsvmqWGAQPG47o,5629
-odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/METADATA,sha256=UJepBb1YaDzdXnuPjmVY2GnbG2c35ct6S9-HSmUdy0s,4068
-odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/WHEEL,sha256=G16H4A3IeoQmnOrYV4ueZGKSjhipXx8zc8nu9FGlvMA,92
-odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo14_addon_sale_automatic_workflow_job-14.0.1.0.1.dev7.dist-info/RECORD,,
+odoo/addons/sale_automatic_workflow_job/tests/test_auto_workflow_job.py,sha256=_un-W3BqRfVajrKBbwMN5tT8y_fHZqJRXL8FhAnqezY,6489
+odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/METADATA,sha256=jAu_roU24W1O7f_uS9YB_D8IoRIeVET3HjPir2YDA6g,4063
+odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo14_addon_sale_automatic_workflow_job-14.0.1.0.2.dist-info/RECORD,,
```

